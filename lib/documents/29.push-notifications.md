# Push Notifications

- 모든 사용자 또는 특정 사용자에게 푸시 알림 보내기
- iOS는 Xcode 설정 및 key 설정 등 필요
- Android는 `firebase_messaging` package만 설치하면 쉽게 사용 가능

## Token을 받아서 database에 저장

- 모든 user(device)가 가진 token을 사용해서 특정 user에게 알림을 보낼 수 있다.
- User database에 token을 저장해서 알림을 보낼 때 사용
- Code
  1. Token 얻기
     ```dart
     final String? token = await FirebaseMessaging.instance.getToken();
     if (token == null) {
         return;
     }
     ```
  2. User database에 저장
     ```dart
     final user = ref.read(authRepo).user;
     await FirebaseFirestore.instance
         .collection("users")
         .doc(user!.uid)
         .update({"token": token})
     ```
  3. Token이 갱신될 때 database에도 갱신
     ```dart
     FirebaseMessaging.instance.onTokenRefresh.listen(
         // 2번 코드 실행
         (newToken) => updateToken(newToken),
     );
     ```
  4. 앱 실행 시 token 초기화
     ```dart
     class MyApp extends ConsumerWidget {
         const MyApp({super.key})
         @override
         Widget build(BuildContext context, WidgetRef ref) {
             // NotificationsProvider에서 1~3번 코드 실행
             ref.watch(notificationsProvider);
             return ...;
         }
     }
     ```

## Notification permission

- `FirebaseMessaging.requestPermission()`으로 사용자에게 알림 권한 요청
- `denied`가 아닌 경우에만 notification을 받을 수 있다.

```dart
NotificationPermission permission = await FirebaseMessaging.instance.requestPermission();
if (permission.authorizationStatus == AuthorizationStatus.denied) {
    return;
}

// Get a notification
```

## FCM campaign

- 기본적인 data (title, message, image 등)를 전송
- Target 설정 가능 (android or iOS or both 등)
- 예약 전송 지원 (매일 아침 등)
- 추가 옵션에서 custom data를 key-value 쌍으로 전송할 수 있음
  - 알림을 받았을 때 특정 screen으로 이동하고 싶다면, 여기서 이동할 screen path를 전송
  - App은 notification을 받아서 지정된 key로 path를 가져온 뒤 해당 screen으로 이동

## Handle notifications

- Foreground : app이 사용되고 있는 상태
- Background : app이 보이지 않는 상태로 실행되고 있음
- Terminated : device를 잠그거나 app을 완전히 종료시킴
- 각 상태 별로 notification을 처리하는 방법이 다르다.

### Foreground notification

- `FirebaseMessaging.onMessage` stream을 구독(listen)
- Foreground에서 notification을 받고 listener가 호출되면 다른 화면으로 redirect 시키는 등 처리

```dart
FirebaseMessaging.onMessage.listen(
    (remoteMessage) => print("In Foreground"),
);
```

### Background notification

- `FirebaseMessaging.onMessageOpenedApp` stream을 구독(listen)
- Background에서 notification을 받고 사용자가 notification을 선택해서 앱으로 들어왔을 때 listener 호출

```dart
FirebaseMessaging.onMessageOpenedApp.listen(
    (remoteMessage) => print("From Background"),
);
```

### Terminated notification

- `FirebaseMessaging.getInitialMessage()`로 앱이 termiated 상태에서 notification을 눌러서 열렸을 때 해당 notification message를 반환함
- 앱을 시작했을 때 notification을 눌러서 들어온게 아니라면 `null`을 반환할 것

```dart
RemoteMessage? message = await FirebaseMessaging.instance.getInitialMessage();
print(message?.data);
```
