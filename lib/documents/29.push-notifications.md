# Push Notifications

- 모든 사용자 또는 특정 사용자에게 푸시 알림 보내기
- iOS는 Xcode 설정 및 key 설정 등 필요
- Android는 `firebase_messaging` package만 설치하면 쉽게 사용 가능

## Token을 받아서 database에 저장

- 모든 user(device)가 가진 token을 사용해서 특정 user에게 알림을 보낼 수 있다.
- User database에 token을 저장해서 알림을 보낼 때 사용
- Code
  1. Token 얻기
     ```dart
     final String? token = await FirebaseMessaging.instance.getToken();
     if (token == null) {
         return;
     }
     ```
  2. User database에 저장
     ```dart
     final user = ref.read(authRepo).user;
     await FirebaseFirestore.instance
         .collection("users")
         .doc(user!.uid)
         .update({"token": token})
     ```
  3. Token이 갱신될 때 database에도 갱신
     ```dart
     FirebaseMessaging.instance.onTokenRefresh.listen(
         // 2번 코드 실행
         (newToken) => updateToken(newToken),
     );
     ```
  4. 앱 실행 시 token 초기화
     ```dart
     class MyApp extends ConsumerWidget {
         const MyApp({super.key})
         @override
         Widget build(BuildContext context, WidgetRef ref) {
             // NotificationsProvider에서 1~3번 코드 실행
             ref.watch(notificationsProvider);
             return ...;
         }
     }
     ```

## Notification permission

- `FirebaseMessaging.requestPermission()`으로 사용자에게 알림 권한 요청
- `denied`가 아닌 경우에만 notification을 받을 수 있다.

```dart
NotificationPermission permission = await FirebaseMessaging.instance.requestPermission();
if (permission.authorizationStatus == AuthorizationStatus.denied) {
    return;
}

// Get a notification
```

## Handle notifications

### Application status

- Foreground : app이 사용되고 있는 상태
- Background : app이 보이지 않는 상태로 실행되고 있음
- Terminated : device를 잠그거나 app을 완전히 종료시킴
- 각 상태 별로 notification을 처리하는 방법이 다르다.

### Foreground notification

- `FirebaseMessaging.onMessage` stream을 구독(listen)
- Foreground에서 notification을 받고 listener가 호출되면 다른 화면으로 redirect 시키는 등 처리

```dart
FirebaseMessaging.onMessage.listen((remoteMessage) => print("In Foreground"));
```
