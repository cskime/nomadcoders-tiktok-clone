# Video upload

- Firestore에 새 document 추가
- Storage에 video file 저장

## Firebase Cloud Functions

- Google backend server에 실행시킬 코드를 배포할 수 있는 기능
- 인증, database, storage 등에 변화가 발생했을 때(observing) custom code를 실행시킬 수 있음
- 사용 예시
  - 새로운 user가 sign up 할 때 기본 profile image를 설정하는 custom code 실행
  - 새로운 video가 upload 되면 아래 작업을 수행하는 custom code 실행 (background 실행)
    1. Background에서 video 다운로드
    2. 다운로드 받은 video에서 thumbnail을 추출해서 file로 생성
    3. Storage bucket에 thumbnail file 업로드
    4. Upload된 영상에 thumbnail property 추가
  - Firestore에서 video document가 제거되면 storage에서 관련 file을 삭제하는 custom code 실행

### Settings

- `cloud_functions` package 설치 (`flutter pub add cloud_functions`)
- `flutterfire configure` 초기화
- `firebase init functions` 초기화

### Custom code 작성

- `/functions/src/index.ts` 에서 작성
- Import the admin (`import * as admin from "firebase-admin";`)
- Import the functions (`import * as functions from "firebase-functions";`)
- `admin.initializeApp();`으로 초기화
- `functions.firestore.document(path)`로 firestore database의 특정 document reference를 얻음
- Reference에서 `onCreate()` 등 함수를 통해 특정 event가 발생했을 때 handler를 실행시킬 수 있음
  - Argument 함수로 `snapshot`과 `context`를 얻음
  - `snapshot` : 생성된 document data (on `onCreate`)
  - `snapshot.ref` : document reference 접근
  - `snapshot.ref.update()` : document 내용 수정

### Deploy

- 작성한 custom code를 Google Cloud Functions backend로 배포
- Typescript code를 서버로 배포해야 실행시킬 수 있다.
- `firebase deploy --only functions` 실행
- 이후 Firebase event가 감지되면 배포해 둔 function이 실행된다.
  - Firestore, authentication 등 어떤 것이든 자동화 할 수 있음

### Trouble shooting

- `firebase init functions` 실행 중 npm package 설치 문제가 발생하면 `/functions` 경로로 들어가서 직접 `npm install`하면 해결된다.
- Deploy 중 `RESOURCE_DIR` 관련 error는 해결하지 못함....

## Upload video

1. Video file을 storage에 저장
   - path : `/videos/:uid/:video_name`
   - 사용자 별로 upload한 video 분류
2. Video가 성공적으로 upload 되었다면 Firestore document에도 추가
   - `FirebaseStorage`를 사용해서 `putFile`로 file을 upload하면 `UploadTask`를 얻음
   - `UploadTask.metadata`가 `null`이 아니면 upload에 성공한 것
   - `VideoModel` object 사용
     - `fileUrl`은 `UploadTask.ref.getDownloadURL()`로 얻을 수 있음
   - `FirebaseFirestore`를 사용해서 document 추가
     - `collection().doc().set()` : document를 찾아서 content 생성 또는 수정
     - `collection().add()` : document 추가
